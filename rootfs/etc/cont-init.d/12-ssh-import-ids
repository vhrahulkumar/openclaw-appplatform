#!/command/with-contenv bash
# Import SSH keys from GitHub and/or SSH_AUTHORIZED_USERS

# TODO: Ensure .ssh directory exists with correct ownership, this is temporary and gets cleaned up by permissions.yaml
mkdir -p /home/ubuntu/.ssh
chown ubuntu:ubuntu /home/ubuntu/.ssh
chmod 700 /home/ubuntu/.ssh

mkdir -p /home/openclaw/.ssh
chown openclaw:openclaw /home/openclaw/.ssh
chmod 700 /home/openclaw/.ssh

# Import SSH keys from GitHub if configured
if [ -n "$GITHUB_USERNAME" ]; then
  echo "[ssh-import] Importing SSH keys for $GITHUB_USERNAME"
  # Use s6-setuidgid to avoid su password prompts, set HOME for ssh-import-id
  HOME=/home/ubuntu /command/s6-setuidgid ubuntu ssh-import-id "gh:$GITHUB_USERNAME" || echo "[ssh-import] Warning: failed to import keys"
  HOME=/home/openclaw /command/s6-setuidgid openclaw ssh-import-id "gh:$GITHUB_USERNAME" || echo "[ssh-import] Warning: failed to import keys"
fi

# Add SSH keys from SSH_AUTHORIZED_USERS if configured
if [ -n "$SSH_AUTHORIZED_USERS" ]; then
  echo "[ssh-import] Adding SSH keys from SSH_AUTHORIZED_USERS"
  # Process each line (SSH keys are typically one per line)
  echo "$SSH_AUTHORIZED_USERS" | while IFS= read -r line || [ -n "$line" ]; do
    # Trim whitespace
    line=$(echo "$line" | xargs)
    # Skip empty lines
    [ -z "$line" ] && continue
    # Check if line looks like an SSH key (starts with ssh-rsa, ssh-ed25519, etc.)
    if echo "$line" | grep -qE "^ssh-(rsa|dss|ed25519|ecdsa)"; then
      echo "$line" >> /home/ubuntu/.ssh/authorized_keys
      echo "$line" >> /home/openclaw/.ssh/authorized_keys
      echo "[ssh-import] Added SSH key: ${line:0:50}..."
    else
      echo "[ssh-import] Warning: Skipping invalid SSH key format: ${line:0:50}..."
    fi
  done
fi
